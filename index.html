<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Firebase Auth — Admin / User UI (With Role Select)</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Tailwind (CDN - good for prototyping) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- AOS (Animate on scroll) -->
  <link href="https://unpkg.com/aos@2.3.4/dist/aos.css" rel="stylesheet" />
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    body {
      background: linear-gradient(180deg, #0f1724, #0b1220);
      color: #e6eef8;
    }
    .card {
      transition: transform 0.18s ease, box-shadow 0.18s ease;
      background: #0b1220;
      border: 1px solid #1f2937;
    }
    .card:hover {
      transform: translateY(-6px);
      box-shadow: 0 12px 30px rgba(2, 6, 23, 0.6);
    }
    .hidden {
      display: none !important;
    }
    .muted {
      color: #9aa7bf;
    }
    .btn-primary {
      background: #0ea5a4;
      border-color: #0ea5a4;
    }
    .btn-danger {
      background: #ef4444;
      border-color: #ef4444;
    }
    .img-thumb {
      height: 160px;
      object-fit: cover;
      border-radius: 6px;
    }
  </style>
</head>
<body class="p-4">
  <div class="container mx-auto max-w-5xl">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="h3">Shop — Admin & User Panel</h1>
      <div>
        <span id="userEmail" class="me-3 muted"></span>
        <button id="btnLogout" class="btn btn-outline-light btn-sm hidden">Logout</button>
      </div>
    </div>

    <!-- Auth Card -->
    <div id="authCard" class="card p-4 mb-4" data-aos="fade-up">
      <ul class="nav nav-tabs mb-3" id="authTabs" role="tablist">
        <li class="nav-item">
          <button
            class="nav-link active"
            id="login-tab"
            data-bs-toggle="tab"
            data-bs-target="#login"
            type="button"
          >
            Login
          </button>
        </li>
        <li class="nav-item">
          <button
            class="nav-link"
            id="signup-tab"
            data-bs-toggle="tab"
            data-bs-target="#signup"
            type="button"
          >
            Sign Up
          </button>
        </li>
      </ul>

      <div class="tab-content">
        <div class="tab-pane fade show active" id="login">
          <div class="mb-3">
            <input
              id="loginEmail"
              class="form-control bg-transparent text-light border-secondary"
              placeholder="Email"
            />
          </div>
          <div class="mb-3">
            <input
              id="loginPassword"
              type="password"
              class="form-control bg-transparent text-light border-secondary"
              placeholder="Password"
            />
          </div>
          <button id="btnLogin" class="btn btn-primary">Login</button>
        </div>

        <div class="tab-pane fade" id="signup">
          <div class="mb-3">
            <input
              id="signupName"
              class="form-control bg-transparent text-light border-secondary"
              placeholder="Full name"
            />
          </div>
          <div class="mb-3">
            <input
              id="signupEmail"
              class="form-control bg-transparent text-light border-secondary"
              placeholder="Email"
            />
          </div>
          <div class="mb-3">
            <input
              id="signupPassword"
              type="password"
              class="form-control bg-transparent text-light border-secondary"
              placeholder="Password"
            />
          </div>
          <button id="btnSignup" class="btn btn-success">Create account</button>
        </div>
      </div>
    </div>

    <!-- Main app area -->
    <div id="appArea" class="hidden">
      <div class="row mb-3">
        <div class="col-md-6">
          <input
            id="searchInput"
            class="form-control bg-transparent text-light border-secondary"
            placeholder="Search items..."
          />
        </div>
        <div class="col-md-6 text-end">
          <button id="btnAddItem" class="btn btn-primary">Add new item</button>
          <button id="btnCart" class="btn btn-outline-light ms-2">
            Cart (<span id="cartCount">0</span>)
          </button>
        </div>
      </div>

      <!-- Admin / User banner -->
      <div id="roleBanner" class="mb-3"></div>

      <!-- Items list -->
      <div id="itemsList" class="row g-3"></div>
    </div>
  </div>

  <!-- Modal for Add/Edit -->
  <div class="modal fade" id="itemModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content bg-dark text-light">
        <div class="modal-header">
          <h5 id="modalTitle" class="modal-title">Add item</h5>
          <button
            type="button"
            class="btn-close btn-close-white"
            data-bs-dismiss="modal"
          ></button>
        </div>
        <div class="modal-body">
          <input
            id="itemTitle"
            class="form-control mb-2 bg-transparent text-light border-secondary"
            placeholder="Title"
          />
          <textarea
            id="itemDescription"
            class="form-control mb-2 bg-transparent text-light border-secondary"
            rows="3"
            placeholder="Description"
          ></textarea>
          <label class="form-label">Image URL (Paste Google Image link)</label>
          <input
            id="itemImageUrl"
            type="text"
            class="form-control bg-transparent text-light border-secondary"
            placeholder="https://..."
          />
        </div>
        <div class="modal-footer">
          <button id="saveItemBtn" class="btn btn-primary">Save</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Cart Modal -->
  <div class="modal fade" id="cartModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content bg-dark text-light">
        <div class="modal-header">
          <h5 class="modal-title">Your Cart</h5>
          <button
            type="button"
            class="btn-close btn-close-white"
            data-bs-dismiss="modal"
          ></button>
        </div>
        <div class="modal-body" id="cartBody"></div>
        <div class="modal-footer">
          <button id="checkoutBtn" class="btn btn-primary">Checkout</button>
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Close
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Role Select Modal -->
  <div
    class="modal fade"
    id="roleSelectModal"
    tabindex="-1"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-sm modal-dialog-centered">
      <div class="modal-content bg-dark text-light">
        <div class="modal-header">
          <h5 class="modal-title">Select Role</h5>
        </div>
        <div class="modal-body text-center">
          <p>Please select your role to continue:</p>
          <button id="btnRoleUser" class="btn btn-primary me-2">User</button>
          <button id="btnRoleAdmin" class="btn btn-warning">Admin</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs (modular) -->
  <script type="module">
    import {
      initializeApp,
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged,
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      setDoc,
      getDoc,
      collection,
      addDoc,
      onSnapshot,
      deleteDoc,
      updateDoc,
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAnYQdIsIHr0SszfPv0BdE-xf7gj97ZIiU",
      authDomain: "app-59d91.firebaseapp.com",
      projectId: "app-59d91",
      storageBucket: "app-59d91.appspot.com",
      messagingSenderId: "1048187741368",
      appId: "1:1048187741368:web:f27a37f758f7bd71e1c04d",
      measurementId: "G-T8DF9KQ69B",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI refs
    const authCard = document.getElementById("authCard");
    const appArea = document.getElementById("appArea");
    const btnSignup = document.getElementById("btnSignup");
    const btnLogin = document.getElementById("btnLogin");
    const btnLogout = document.getElementById("btnLogout");
    const userEmail = document.getElementById("userEmail");
    const roleBanner = document.getElementById("roleBanner");
    const itemsList = document.getElementById("itemsList");
    const btnAddItem = document.getElementById("btnAddItem");
    const saveItemBtn = document.getElementById("saveItemBtn");
    const modalTitle = document.getElementById("modalTitle");

    // modals
    let itemModal = null;
    function ensureItemModal() {
      if (!itemModal) itemModal = new bootstrap.Modal(document.getElementById("itemModal"));
      return itemModal;
    }
    let cartModal = null;
    function ensureCartModal() {
      if (!cartModal) cartModal = new bootstrap.Modal(document.getElementById("cartModal"));
      return cartModal;
    }
    let roleSelectModal = null;
    function ensureRoleSelectModal() {
      if (!roleSelectModal) roleSelectModal = new bootstrap.Modal(document.getElementById("roleSelectModal"));
      return roleSelectModal;
    }

    let currentUser = null;
    let editingItemId = null;
    let unsubscribeItems = null;
    let selectedRole = null;

    // helpers
    function showToast(icon, title) {
      Swal.fire({
        toast: true,
        position: "top-end",
        icon,
        title,
        showConfirmButton: false,
        timer: 2000,
      });
    }

    // signup
    btnSignup.addEventListener("click", async () => {
      const name = document.getElementById("signupName").value.trim();
      const email = document.getElementById("signupEmail").value.trim();
      const password = document.getElementById("signupPassword").value;
      if (!name || !email || !password) return showToast("error", "Please fill all fields");
      try {
        const userCred = await createUserWithEmailAndPassword(auth, email, password);
        const uid = userCred.user.uid;
        // create user doc AFTER auth creation
        await setDoc(doc(db, "users", uid), { name, email, isAdmin: false, createdAt: new Date() });
        showToast("success", "Account created");
      } catch (err) {
        showToast("error", err.message);
      }
    });

    // login
    btnLogin.addEventListener("click", async () => {
      const email = document.getElementById("loginEmail").value.trim();
      const password = document.getElementById("loginPassword").value;
      if (!email || !password) return showToast("error", "Please fill both fields");
      try {
        await signInWithEmailAndPassword(auth, email, password);
        // On successful login, the auth state observer will trigger showing role modal
      } catch (err) {
        showToast("error", err.message);
      }
    });

    btnLogout.addEventListener("click", async () => {
      await signOut(auth);
      showToast("success", "Logged out");
    });

    // auth observer
    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      if (user) {
        // Show role select modal only if role not set yet
        const uref = doc(db, "users", user.uid);
        const usnap = await getDoc(uref);
        let userData = usnap.exists() ? usnap.data() : null;

        // If userData does not exist, create it (with default isAdmin false)
        if (!userData) {
          await setDoc(uref, { name: user.displayName || "", email: user.email, isAdmin: false, createdAt: new Date() });
          userData = (await getDoc(uref)).data();
        }

        // If role is not set (null or undefined), show role select modal
        if (userData.isAdmin === undefined || userData.isAdmin === null) {
          authCard.classList.add("hidden");
          appArea.classList.add("hidden");
          btnLogout.classList.add("hidden");
          userEmail.textContent = "";
          selectedRole = null;
          ensureRoleSelectModal().show();
        } else {
          // Role exists, render UI accordingly
          renderRoleBanner(userData.isAdmin);
          startItemsListener(userData.isAdmin);

          userEmail.textContent = user.email;
          btnLogout.classList.remove("hidden");
          authCard.classList.add("hidden");
          appArea.classList.remove("hidden");
          ensureRoleSelectModal().hide();
        }
      } else {
        userEmail.textContent = "";
        btnLogout.classList.add("hidden");
        authCard.classList.remove("hidden");
        appArea.classList.add("hidden");
        renderRoleBanner(false);
        if (unsubscribeItems) unsubscribeItems();
        ensureRoleSelectModal().hide();
      }
    });

    // Role selection buttons handlers
    document.getElementById("btnRoleUser").addEventListener("click", async () => {
      selectedRole = "user";
      await onRoleSelected();
    });
    document.getElementById("btnRoleAdmin").addEventListener("click", async () => {
      selectedRole = "admin";
      await onRoleSelected();
    });

    async function onRoleSelected() {
      if (!currentUser) return;
      const uref = doc(db, "users", currentUser.uid);
      await setDoc(uref, { isAdmin: selectedRole === "admin" }, { merge: true });
      ensureRoleSelectModal().hide();

      renderRoleBanner(selectedRole === "admin");
      startItemsListener(selectedRole === "admin");

      userEmail.textContent = currentUser.email;
      btnLogout.classList.remove("hidden");
      authCard.classList.add("hidden");
      appArea.classList.remove("hidden");
    }

    function renderRoleBanner(isAdmin) {
      if (isAdmin) {
        roleBanner.innerHTML =
          '<div class="alert alert-warning">You are <strong>Admin</strong>. You can edit and delete any item.</div>';
        btnAddItem.classList.remove("hidden");
      } else {
        roleBanner.innerHTML =
          '<div class="alert alert-info">You are <strong>User</strong>. You can add items and manage your cart.</div>';
        btnAddItem.classList.remove("hidden");
      }
    }

    // items listener
    function startItemsListener(isAdmin) {
      if (unsubscribeItems) unsubscribeItems();
      const itemsCol = collection(db, "items");
      unsubscribeItems = onSnapshot(itemsCol, (snapshot) => {
        renderItems(snapshot.docs.map((d) => ({ id: d.id, ...d.data() })), isAdmin);
      });
    }

    function renderItems(items, isAdminView) {
      itemsList.innerHTML = "";
      if (!items.length) {
        itemsList.innerHTML =
          '<div class="col-12"><div class="p-4 text-center muted">No items yet.</div></div>';
        return;
      }
      items.forEach((item) => {
        const col = document.createElement("div");
        col.className = "col-sm-6 col-md-4";
        col.innerHTML = `
        <div class="card p-3 h-100" data-aos="zoom-in">
          <img src="${item.imageUrl || ""}" class="img-thumb mb-2 w-100" alt="">
          <div class="d-flex justify-content-between align-items-start">
            <h5 class="mb-1">${escapeHtml(item.title || item.name || "")}</h5>
            <small class="muted">${item.ownerName || ""}</small>
          </div>
          <p class="small muted">${escapeHtml(item.description || "")}</p>
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <small class="muted">${
                item.createdAt
                  ? new Date(
                      item.createdAt.seconds
                        ? item.createdAt.seconds * 1000
                        : item.createdAt
                    ).toLocaleString()
                  : ""
              }</small>
            </div>
            <div>
              ${
                isAdminView || item.ownerUid === (currentUser && currentUser.uid)
                  ? `<button class="btn btn-sm btn-outline-light me-1 btnEdit" data-id="${item.id}">Edit</button>
                     <button class="btn btn-sm btn-danger btnDelete" data-id="${item.id}">Delete</button>`
                  : ""
              }
              <button class="btn btn-sm btn-primary btnAddCart" data-id="${item.id}">Add to cart</button>
            </div>
          </div>
        </div>`;
        itemsList.appendChild(col);
      });

      // Edit buttons
      document.querySelectorAll(".btnEdit").forEach((btn) => {
        btn.addEventListener("click", async (e) => {
          editingItemId = e.target.dataset.id;
          const docRef = doc(db, "items", editingItemId);
          const docSnap = await getDoc(docRef);
          if (docSnap.exists()) {
            const data = docSnap.data();
            modalTitle.textContent = "Edit item";
            document.getElementById("itemTitle").value = data.title || "";
            document.getElementById("itemDescription").value = data.description || "";
            document.getElementById("itemImageUrl").value = data.imageUrl || "";
            ensureItemModal().show();
          }
        });
      });

      // Delete buttons
      document.querySelectorAll(".btnDelete").forEach((btn) => {
        btn.addEventListener("click", async (e) => {
          const id = e.target.dataset.id;
          const confirmed = await Swal.fire({
            icon: "warning",
            title: "Are you sure?",
            text: "This item will be deleted permanently.",
            showCancelButton: true,
            confirmButtonText: "Delete",
          });
          if (confirmed.isConfirmed) {
            await deleteDoc(doc(db, "items", id));
            showToast("success", "Deleted");
          }
        });
      });

      // Add to cart buttons
      document.querySelectorAll(".btnAddCart").forEach((btn) => {
        btn.addEventListener("click", async (e) => {
          const id = e.target.dataset.id;
          if (!currentUser) return showToast("error", "Login first");
          const cartRef = doc(db, "carts", currentUser.uid);
          const cartSnap = await getDoc(cartRef);
          let cartData = cartSnap.exists() ? cartSnap.data() : { items: [] };
          if (!cartData.items.includes(id)) {
            cartData.items.push(id);
            await setDoc(cartRef, cartData);
            updateCartCount();
            showToast("success", "Added to cart");
          } else {
            showToast("info", "Already in cart");
          }
        });
      });
    }

    // Escape HTML helper to prevent XSS
    function escapeHtml(text) {
      return text.replace(/[&<>"']/g, (m) => {
        switch (m) {
          case "&":
            return "&amp;";
          case "<":
            return "&lt;";
          case ">":
            return "&gt;";
          case '"':
            return "&quot;";
          case "'":
            return "&#039;";
          default:
            return m;
        }
      });
    }

    // Add item button
    btnAddItem.addEventListener("click", () => {
      editingItemId = null;
      modalTitle.textContent = "Add item";
      document.getElementById("itemTitle").value = "";
      document.getElementById("itemDescription").value = "";
      document.getElementById("itemImageUrl").value = "";
      ensureItemModal().show();
    });

    // Save item (add or update)
    saveItemBtn.addEventListener("click", async () => {
      const title = document.getElementById("itemTitle").value.trim();
      const description = document.getElementById("itemDescription").value.trim();
      const imageUrl = document.getElementById("itemImageUrl").value.trim();

      if (!title) return showToast("error", "Please enter title");
      if (!imageUrl) return showToast("error", "Please enter image URL");
      if (!currentUser) return showToast("error", "Login first");

      try {
        if (editingItemId) {
          await updateDoc(doc(db, "items", editingItemId), {
            title,
            description,
            imageUrl,
          });
          showToast("success", "Updated");
        } else {
          await addDoc(collection(db, "items"), {
            title,
            description,
            imageUrl,
            ownerUid: currentUser.uid,
            ownerName: (await getDoc(doc(db, "users", currentUser.uid))).data()
              .name || currentUser.email,
            createdAt: new Date(),
          });
          showToast("success", "Added");
        }
        ensureItemModal().hide();
      } catch (err) {
        showToast("error", err.message);
      }
    });

    // Cart functionality (simplified)
    const btnCart = document.getElementById("btnCart");
    const cartCountSpan = document.getElementById("cartCount");
    const cartBody = document.getElementById("cartBody");
    const checkoutBtn = document.getElementById("checkoutBtn");

    btnCart.addEventListener("click", async () => {
      if (!currentUser) return showToast("error", "Login first");
      const cartRef = doc(db, "carts", currentUser.uid);
      const cartSnap = await getDoc(cartRef);
      let cartData = cartSnap.exists() ? cartSnap.data() : { items: [] };

      if (cartData.items.length === 0) {
        cartBody.innerHTML = '<p class="text-center muted">Cart is empty.</p>';
      } else {
        // Fetch item details for cart
        let cartHtml = "";
        for (const itemId of cartData.items) {
          const itemDoc = await getDoc(doc(db, "items", itemId));
          if (itemDoc.exists()) {
            const item = itemDoc.data();
            cartHtml += `
              <div class="d-flex align-items-center mb-2">
                <img src="${item.imageUrl}" alt="" width="60" class="me-2 rounded" />
                <div class="flex-grow-1">
                  <strong>${escapeHtml(item.title)}</strong><br />
                  <small class="text-muted">${escapeHtml(item.description)}</small>
                </div>
                <button class="btn btn-sm btn-danger btnRemoveCart" data-id="${itemId}">Remove</button>
              </div>`;
          }
        }
        cartBody.innerHTML = cartHtml;

        // Remove from cart buttons
        document.querySelectorAll(".btnRemoveCart").forEach((btn) => {
          btn.addEventListener("click", async (e) => {
            const id = e.target.dataset.id;
            cartData.items = cartData.items.filter((i) => i !== id);
            await setDoc(cartRef, cartData);
            updateCartCount();
            btnCart.click(); // refresh modal
          });
        });
      }

      ensureCartModal().show();
    });

    checkoutBtn.addEventListener("click", () => {
      Swal.fire({
        icon: "success",
        title: "Checkout",
        text: "Thank you for your purchase! (Feature to be implemented)",
      });
      ensureCartModal().hide();
    });

    async function updateCartCount() {
      if (!currentUser) {
        cartCountSpan.textContent = "0";
        return;
      }
      const cartRef = doc(db, "carts", currentUser.uid);
      const cartSnap = await getDoc(cartRef);
      let cartData = cartSnap.exists() ? cartSnap.data() : { items: [] };
      cartCountSpan.textContent = cartData.items.length || "0";
    }

    // Initial cart count update on user login
    onAuthStateChanged(auth, (user) => {
      if (user) updateCartCount();
      else cartCountSpan.textContent = "0";
    });
  </script>

  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
  <!-- AOS animation init -->
  <script src="https://unpkg.com/aos@2.3.4/dist/aos.js"></script>
  <script>
    AOS.init();
  </script>
</body>
</html>
